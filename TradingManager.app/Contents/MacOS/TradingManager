#!/bin/bash

# äº¤æ˜“è®°å½•ç®¡ç†ç³»ç»Ÿ - Macåº”ç”¨ç¨‹åºå¯åŠ¨å™¨
# ç‰ˆæœ¬: v2.0

# è®¾ç½®é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# è·å–åº”ç”¨ç¨‹åºè·¯å¾„
APP_PATH="$(dirname "$(dirname "$(dirname "$0")")")"
PROJECT_PATH="$(dirname "$(dirname "$(dirname "$0")")")"

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ˜¾ç¤ºå¯åŠ¨æ¨ªå¹…
show_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                              â•‘"
    echo "â•‘          ğŸš€ äº¤æ˜“è®°å½•ç®¡ç†ç³»ç»Ÿ - Macåº”ç”¨ç¨‹åº                   â•‘"
    echo "â•‘                                                              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ˜¾ç¤ºmacOSé€šçŸ¥
show_notification() {
    local title="$1"
    local message="$2"

    osascript -e "display notification \"$title\" with subtitle \"$message\"" 2>/dev/null || true
}

# æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿è¡Œ
check_process() {
    local service_name="$1"
    local pattern="$2"

    if pgrep -f "$pattern" > /dev/null; then
        log_success "$service_name æ­£åœ¨è¿è¡Œ"
        return 0
    else
        log_warning "$service_name æœªè¿è¡Œ"
        return 1
    fi
}

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
check_port() {
    local port="$1"
    if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
        return 0  # ç«¯å£è¢«å ç”¨
    else
        return 1  # ç«¯å£å¯ç”¨
    fi
}

# ç­‰å¾…æœåŠ¡å¯åŠ¨
wait_for_service() {
    local url="$1"
    local service_name="$2"
    local max_attempts=30
    local attempt=1

    log_info "ç­‰å¾… $service_name å¯åŠ¨..."
    while [ $attempt -le $max_attempts ]; do
        if curl -s "$url" >/dev/null 2>&1; then
            log_success "$service_name å·²å¯åŠ¨"
            return 0
        fi
        echo -n "."
        sleep 1
        attempt=$((attempt + 1))
    done

    echo
    log_error "$service_name å¯åŠ¨è¶…æ—¶"
    return 1
}

# æ˜¾ç¤ºå¯åŠ¨è¿›åº¦
show_progress() {
    local current="$1"
    local total="$2"
    local message="$3"

    local percentage=$((current * 100 / total))
    local filled=$((percentage / 5))
    local empty=$((20 - filled))

    printf "\r%s: [" "$message"
    printf "%*s" $filled | tr ' ' 'â–ˆ'
    printf "%*s" $empty | tr ' ' 'â–‘'
    printf "] %d%%" $percentage
}

# ä¸»å¯åŠ¨å‡½æ•°
start_application() {
    show_banner

    # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
    cd "$PROJECT_PATH"

    # æ­¥éª¤1: æ£€æŸ¥Python
    show_progress 1 6 "æ£€æŸ¥Pythonç¯å¢ƒ"
    if ! command -v python3 &> /dev/null; then
        log_error "Python3 æœªå®‰è£…"
        show_notification "å¯åŠ¨å¤±è´¥" "Python3æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Python 3.13+"
        exit 1
    fi

    # æ­¥éª¤2: æ£€æŸ¥Node.js
    show_progress 2 6 "æ£€æŸ¥Node.jsç¯å¢ƒ"
    if ! command -v node &> /dev/null; then
        log_error "Node.js æœªå®‰è£…"
        show_notification "å¯åŠ¨å¤±è´¥" "Node.jsæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Node.js 16+"
        exit 1
    fi

    # æ­¥éª¤3: æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
    show_progress 3 6 "æ¿€æ´»Pythonè™šæ‹Ÿç¯å¢ƒ"
    if [ ! -d "venv" ]; then
        log_info "åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
        python3 -m venv venv
    fi
    source venv/bin/activate

    # æ­¥éª¤4: æ£€æŸ¥Pythonä¾èµ–
    show_progress 4 6 "æ£€æŸ¥Pythonä¾èµ–"
    if [ -f "backend/requirements.txt" ]; then
        pip install -q -r backend/requirements.txt
    fi

    # æ­¥éª¤5: åˆ›å»ºå¿…è¦ç›®å½•
    show_progress 5 6 "åˆ›å»ºç›®å½•ç»“æ„"
    mkdir -p logs backend/data backend/credentials trading_records

    # æ­¥éª¤6: å¯åŠ¨æœåŠ¡
    show_progress 6 6 "å¯åŠ¨WebæœåŠ¡"

    # æŸ¥æ‰¾å¯ç”¨ç«¯å£
    API_PORT=5002
    while check_port $API_PORT; do
        API_PORT=$((API_PORT + 1))
    done

    # è®¾ç½®ç¯å¢ƒå˜é‡
    export API_PORT=$API_PORT
    export PYTHONPATH="${PROJECT_PATH}/backend:$PYTHONPATH"
    export REACT_APP_API_URL="http://localhost:$API_PORT/api"

    # å¯åŠ¨APIæœåŠ¡å™¨ï¼ˆåå°ï¼‰
    cd backend
    nohup python app/api_server.py > ../logs/api_server.log 2>&1 &
    API_PID=$!
    echo $API_PID > ../.api_server.pid
    cd ..

    # ç­‰å¾…APIæœåŠ¡å™¨å¯åŠ¨
    API_URL="http://localhost:$API_PORT/api/health"
    if wait_for_service "$API_URL" "APIæœåŠ¡å™¨"; then
        log_success "APIæœåŠ¡å™¨å·²å¯åŠ¨: $API_URL"
    else
        log_error "APIæœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
        show_notification "å¯åŠ¨å¤±è´¥" "APIæœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
        exit 1
    fi

    # å¯åŠ¨å‰ç«¯æœåŠ¡å™¨
    cd frontend
    if [ ! -d "node_modules" ]; then
        npm install
    fi

    # æŸ¥æ‰¾å¯ç”¨ç«¯å£
    FRONTEND_PORT=5173
    while check_port $FRONTEND_PORT; do
        FRONTEND_PORT=$((FRONTEND_PORT + 1))
    done

    # å¯åŠ¨å‰ç«¯æœåŠ¡å™¨ï¼ˆåå°ï¼‰
    nohup npm run dev -- --port $FRONTEND_PORT > ../logs/frontend.log 2>&1 &
    FRONTEND_PID=$!
    echo $FRONTEND_PID > ../.frontend.pid
    cd ..

    # ç­‰å¾…å‰ç«¯æœåŠ¡å™¨å¯åŠ¨
    FRONTEND_URL="http://localhost:$FRONTEND_PORT"
    if wait_for_service "$FRONTEND_URL" "å‰ç«¯æœåŠ¡å™¨"; then
        log_success "å‰ç«¯æœåŠ¡å™¨å·²å¯åŠ¨: $FRONTEND_URL"
    else
        log_error "å‰ç«¯æœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
        show_notification "å¯åŠ¨å¤±è´¥" "å‰ç«¯æœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
        exit 1
    fi

    # æ˜¾ç¤ºå®Œæˆä¿¡æ¯
    echo
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘${NC}                      ğŸ‰ å¯åŠ¨å®Œæˆï¼                             ${GREEN}â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    echo -e "${CYAN}ğŸŒ å‰ç«¯åº”ç”¨:${NC} $FRONTEND_URL"
    echo -e "${CYAN}ğŸ”— APIæœåŠ¡å™¨:${NC} $API_URL"
    echo

    # æ‰“å¼€æµè§ˆå™¨
    open "$FRONTEND_URL"

    # æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
    show_notification "ç³»ç»Ÿå·²å¯åŠ¨" "äº¤æ˜“è®°å½•ç®¡ç†ç³»ç»Ÿè¿è¡Œä¸­: $FRONTEND_URL"

    log_success "åº”ç”¨ç¨‹åºå·²åœ¨åå°è¿è¡Œ"
}

# ä¸»å‡½æ•°
main() {
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰æœåŠ¡åœ¨è¿è¡Œ
    if pgrep -f "api_server.py" > /dev/null || pgrep -f "npm run dev" > /dev/null; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰æœåŠ¡æ­£åœ¨è¿è¡Œ${NC}"
        echo -e "${BLUE}é€‰æ‹©æ“ä½œ:${NC}"
        echo "1) é‡æ–°å¯åŠ¨æœåŠ¡"
        echo "2) æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
        echo "3) åœæ­¢æ‰€æœ‰æœåŠ¡"
        echo "4) å¯åŠ¨æ–°å®ä¾‹"
        echo
        read -p "è¯·è¾“å…¥é€‰æ‹© (1-4): " choice

        case $choice in
            1)
                echo "æ­£åœ¨åœæ­¢ç°æœ‰æœåŠ¡..."
                pkill -f "api_server.py" 2>/dev/null || true
                pkill -f "npm run dev" 2>/dev/null || true
                sleep 2
                echo "é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åº..."
                start_application
                ;;
            2)
                echo "æœåŠ¡çŠ¶æ€:"
                if check_process "APIæœåŠ¡å™¨" "api_server.py"; then
                    echo "âœ… APIæœåŠ¡å™¨è¿è¡Œä¸­"
                fi
                if check_process "å‰ç«¯æœåŠ¡å™¨" "npm run dev"; then
                    echo "âœ… å‰ç«¯æœåŠ¡å™¨è¿è¡Œä¸­"
                fi
                ;;
            3)
                echo "æ­£åœ¨åœæ­¢æ‰€æœ‰æœåŠ¡..."
                pkill -f "api_server.py" 2>/dev/null || true
                pkill -f "npm run dev" 2>/dev/null || true
                rm -f .api_server.pid .frontend.pid
                show_notification "æœåŠ¡å·²åœæ­¢" "æ‰€æœ‰æœåŠ¡å·²åœæ­¢"
                ;;
            4)
                start_application
                ;;
            *)
                echo "æ— æ•ˆé€‰æ‹©"
                ;;
        esac
    else
        start_application
    fi
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"